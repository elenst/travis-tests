language: perl
dist: jessie

sudo: enabled

cache:
  directories:
    - $HOME/server

before_cache:
  rm -rf $HOME/server/mysql-test

before_install:
- cpanm -n DBI DBD::mysql
- sudo apt-get install libaio1 libaio-dev libjemalloc1 gdb libnuma1

env:
- TYPE=downgrade                               OLD=10.1.21   COMPRESSION=none,zlib  PAGE_SIZE=all
- TYPE=downgrade                               OLD=10.1.22   COMPRESSION=none,zlib  PAGE_SIZE=all
- TYPE=downgrade                               OLD=10.1.23   COMPRESSION=none,zlib  PAGE_SIZE=all
- TYPE=downgrade                               OLD=10.1.24   COMPRESSION=none,zlib  PAGE_SIZE=all
- TYPE=downgrade                               OLD=10.1.25   COMPRESSION=none,zlib  PAGE_SIZE=all
- TYPE=downgrade                               OLD=10.1.26   COMPRESSION=none,zlib  PAGE_SIZE=all
- TYPE=downgrade                               OLD=10.1.27   COMPRESSION=none,zlib  PAGE_SIZE=all
- TYPE=downgrade                               OLD=10.1.28   COMPRESSION=none,zlib  PAGE_SIZE=all
- TYPE=downgrade                               OLD=10.1.29   COMPRESSION=none,zlib  PAGE_SIZE=all
- TYPE=downgrade                               OLD=10.1.30   COMPRESSION=none,zlib  PAGE_SIZE=all
- TYPE=downgrade SERVER_BRANCH=mariadb-10.1.22 OLD=10.1.21   COMPRESSION=none,zlib  PAGE_SIZE=all
- TYPE=downgrade SERVER_BRANCH=mariadb-10.1.23 OLD=10.1.22   COMPRESSION=none,zlib  PAGE_SIZE=all
- TYPE=downgrade SERVER_BRANCH=mariadb-10.1.24 OLD=10.1.23   COMPRESSION=none,zlib  PAGE_SIZE=all
- TYPE=downgrade SERVER_BRANCH=mariadb-10.1.25 OLD=10.1.24   COMPRESSION=none,zlib  PAGE_SIZE=all
- TYPE=downgrade SERVER_BRANCH=mariadb-10.1.26 OLD=10.1.25   COMPRESSION=none,zlib  PAGE_SIZE=all
- TYPE=downgrade SERVER_BRANCH=mariadb-10.1.27 OLD=10.1.26   COMPRESSION=none,zlib  PAGE_SIZE=all
- TYPE=downgrade SERVER_BRANCH=mariadb-10.1.28 OLD=10.1.27   COMPRESSION=none,zlib  PAGE_SIZE=all
- TYPE=downgrade SERVER_BRANCH=mariadb-10.1.29 OLD=10.1.28   COMPRESSION=none,zlib  PAGE_SIZE=all
- TYPE=downgrade SERVER_BRANCH=mariadb-10.1.30 OLD=10.1.29   COMPRESSION=none,zlib  PAGE_SIZE=all

install:
- cd $HOME
- export BASEDIR=$HOME/server
- export RQG_HOME=$HOME/rqg
- export SCRIPT_DIR=$HOME/mariadb-tests/scripts
- export CMAKE_OPTIONS="-DCMAKE_BUILD_TYPE=Debug -DPLUGIN_SPHINX=NO -DPLUGIN_TOKUDB=NO -DPLUGIN_ROCKSDB=NO -DPLUGIN_MROONGA=NO -DPLUGIN_FEDERATED=NO -DPLUGIN_FEDERATEDX=NO -DPLUGIN_CONNECT=NO -DPLUGIN_SPIDER=NO -DWITH_MARIABACKUP=OFF"
- if [ -z "$SERVER_BRANCH" ] ; then SERVER=10.1 ; else SERVER=$SERVER_BRANCH ; fi
- git clone https://github.com/elenst/rqg --branch experimental rqg
- git clone https://github.com/MariaDB/server --depth=1 --branch $SERVER src
- git clone https://github.com/elenst/mariadb-tests mariadb-tests
- . $SCRIPT_DIR/get_old_version.sh $OLD
- cd $RQG_HOME && git log -1
- cd $SCRIPT_DIR && git log -1

script:

- cd $HOME
- . $SCRIPT_DIR/build_if_not_cached.sh
- cd $RQG_HOME
- perl $RQG_HOME/combinations.pl --new --config=$SCRIPT_DIR/travis_combinations.cc --run-all-combinations-once --force --workdir=$HOME/logs || true
- cd $HOME
- . $SCRIPT_DIR/collect_failure_info.sh $HOME/logs || true
#- perl $SCRIPT_DIR/parse_upgrade_logs.pl --mode=jira --nowarnings $HOME/logs/trial*
- perl $SCRIPT_DIR/parse_upgrade_logs.pl --mode=kb --nowarnings $HOME/logs/trial*
- perl $SCRIPT_DIR/parse_upgrade_logs.pl --mode=text --nowarnings $HOME/logs/trial*
- if [ ! -e $BASEDIR/test_result ] ; then echo $? > $BASEDIR/test_result ; fi
